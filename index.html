<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Carga para Motocicleta Eléctrica - SPA Interactiva v5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { background-color: #059669; color: white; } /* emerald-600 */
        .tab-button { background-color: #D1FAE5; color: #065F46; } /* emerald-100, emerald-800 */
        .details-content { display: none; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .details-content.open { max-height: 1000px; /* Adjust as needed */ }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* Tailwind max-w-2xl */
            margin-left: auto;
            margin-right: auto;
            height: 300px; /* Base height, can be responsive with Tailwind h-[] */
            max-height: 400px;
        }
        @media (min-width: 768px) { /* md breakpoint */
            .chart-container {
                height: 350px;
            }
        }
        
        /* Styles for Battery Visualizer */
        #battery-visualizer {
            position: relative;
            width: 80px; /* Ancho de la batería */
            height: 160px; /* Alto de la batería */
            border: 3px solid #6b7280; /* neutral-500 */
            border-radius: 10px;
            margin: 20px auto;
            overflow: hidden;
            display: flex;
            flex-direction: column-reverse; /* Para que el llenado sea de abajo hacia arriba */
        }
        #battery-visualizer::before { /* Tapa superior de la batería */
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 8px;
            background-color: #6b7280; /* neutral-500 */
            border-radius: 3px;
        }
        #battery-fill {
            width: 100%;
            height: 0%; /* Altura inicial del llenado */
            background-color: #D1FAE5; /* Color inicial (light green) */
            transition: height 0.7s ease-out, background-color 0.7s ease-out;
        }
    </style>
</head>
<body class="bg-stone-100 text-neutral-800 antialiased">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-5xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-emerald-700">Centro de Carga para Motocicleta Eléctrica</h1>
            <p class="text-neutral-600 mt-2">Una aplicación interactiva para explorar el informe técnico y herramientas útiles.</p>
        </header>

        <nav class="mb-6 flex flex-wrap justify-center gap-2 sm:gap-3">
            <button class="tab-button py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-emerald-500 hover:text-white transition-colors active" onclick="openTab(event, 'resumen')">Resumen del Sistema</button>
            <button class="tab-button py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-emerald-500 hover:text-white transition-colors" onclick="openTab(event, 'cargador')">Detalles del Cargador</button>
            <button class="tab-button py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-emerald-500 hover:text-white transition-colors" onclick="openTab(event, 'calculos')">Cálculos y Herramientas</button>
            <button class="tab-button py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-emerald-500 hover:text-white transition-colors" onclick="openTab(event, 'conclusion')">Conclusión</button>
        </nav>

        <main>
            <section id="resumen" class="tab-content active bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-emerald-700 mb-4">1. Resumen del Sistema</h2>
                <p class="mb-4 text-neutral-700">Esta sección presenta una visión general del sistema de carga diseñado para la motocicleta eléctrica. El objetivo es asegurar una carga eficiente, segura y que prolongue la vida útil de las baterías. A continuación, se detallan las especificaciones clave del banco de baterías y del cargador seleccionado.</p>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-stone-50 p-4 rounded-lg shadow">
                        <h3 class="text-xl font-semibold text-emerald-600 mb-3">Especificaciones del Banco de Baterías</h3>
                        <ul class="list-disc list-inside text-neutral-700 space-y-1">
                            <li><strong>Número de Baterías:</strong> 5 unidades</li>
                            <li><strong>Tipo de Batería:</strong> Plomo-ácido (sellada, AGM o Gel)</li>
                            <li><strong>Voltaje Nominal por Batería:</strong> 12 VDC</li>
                            <li><strong>Capacidad Nominal por Batería:</strong> 20 Ah</li>
                            <li><strong>Configuración:</strong> Conexión en serie</li>
                            <li class="mt-2 pt-2 border-t border-stone-300"><strong>Voltaje Nominal Total del Banco:</strong> <span class="font-bold text-emerald-700">60 VDC</span></li>
                            <li><strong>Capacidad Nominal Total del Banco:</strong> <span class="font-bold text-emerald-700">20 Ah</span></li>
                            <li><strong>Energía Almacenada (Nominal):</strong> <span class="font-bold text-emerald-700">1.2 kWh</span></li>
                        </ul>
                    </div>

                    <div class="bg-stone-50 p-4 rounded-lg shadow">
                        <h3 class="text-xl font-semibold text-emerald-600 mb-3">Cargador Seleccionado</h3>
                        <img src="https://placehold.co/300x100/E0E0E0/333333?text=Etiqueta+Cargador+120-60V17-24Ah" alt="Etiqueta del Cargador" class="mx-auto mb-3 rounded-md" onerror="this.src='https://placehold.co/300x100/E0E0E0/333333?text=Imagen+no+disponible'; this.onerror=null;">
                        <ul class="list-disc list-inside text-neutral-700 space-y-1">
                            <li><strong>Modelo:</strong> 120-60V17-24Ah</li>
                            <li><strong>Entrada:</strong> ~110V ±10% 50-60Hz (≤260W)</li>
                            <li><strong>Salida:</strong> <span class="font-bold text-emerald-700">DC 73.5V / 3A</span></li>
                        </ul>
                        <p class="mt-3 text-sm text-neutral-600">Este cargador ha sido elegido por su compatibilidad óptima con las especificaciones del banco de baterías.</p>
                    </div>
                </div>
            </section>

            <section id="cargador" class="tab-content bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-emerald-700 mb-4">2. Detalles del Cargador</h2>
                <p class="mb-6 text-neutral-700">El cargador modelo 120-60V17-24Ah es un componente crucial del sistema. Su selección se basó en criterios técnicos para asegurar una carga adecuada. A continuación, se exploran su justificación, las etapas de carga automáticas que implementa y los modos de uso recomendados para el usuario.</p>

                <div class="mb-6">
                    <button onclick="toggleDetails('justificacion-details')" class="w-full text-left py-3 px-4 bg-emerald-50 hover:bg-emerald-100 rounded-lg font-semibold text-emerald-700 transition-colors flex justify-between items-center">
                        Justificación de la Selección del Cargador
                        <span class="transform transition-transform details-arrow">&#9662;</span>
                    </button>
                    <div id="justificacion-details" class="details-content mt-2 px-4 text-neutral-700 space-y-2">
                        <p><strong>Compatibilidad de Voltaje:</strong> La salida de 73.5V DC es ideal para baterías de plomo-ácido de 60V, asegurando carga completa.</p>
                        <p><strong>Compatibilidad de Corriente:</strong> Los 3A de salida están en el rango óptimo (C/10 a C/5) para baterías de 20Ah, promoviendo una carga eficiente y segura.</p>
                        <p><strong>Compatibilidad de Capacidad:</strong> Diseñado para baterías de 17-24Ah, cubriendo la capacidad de 20Ah del banco.</p>
                        <p><strong>Tipo de Batería:</strong> Las advertencias del fabricante (gas volátil, ventilación) confirman su adecuación para plomo-ácido.</p>
                    </div>
                </div>

                <div class="mb-6">
                     <h3 class="text-xl font-semibold text-emerald-600 mb-3">Etapas de Carga Automáticas</h3>
                     <div class="grid md:grid-cols-3 gap-4">
                        <div id="stage-bulk" class="bg-stone-50 p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition-shadow" onclick="showStageDetails('bulk')">
                            <h4 class="font-semibold text-emerald-700">Etapa 1: Carga Bulk (Corriente Constante)</h4>
                            <p class="text-sm text-neutral-600 mt-1">Corriente máxima (3A) hasta alcanzar 73.5V. Carga rápida de la mayor parte de la capacidad.</p>
                        </div>
                        <div id="stage-absorption" class="bg-stone-50 p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition-shadow" onclick="showStageDetails('absorption')">
                            <h4 class="font-semibold text-emerald-700">Etapa 2: Carga de Absorción (Voltaje Constante)</h4>
                            <p class="text-sm text-neutral-600 mt-1">Voltaje constante a 73.5V, corriente decreciente. Asegura carga al 100%.</p>
                        </div>
                        <div id="stage-float" class="bg-stone-50 p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition-shadow" onclick="showStageDetails('float')">
                            <h4 class="font-semibold text-emerald-700">Etapa 3: Carga de Flotación (Mantenimiento)</h4>
                            <p class="text-sm text-neutral-600 mt-1">Voltaje reducido/mantenido, corriente mínima. Compensa autodescarga.</p>
                        </div>
                     </div>
                     <div id="stage-details-display" class="mt-4 p-4 bg-emerald-50 rounded-lg text-neutral-700 hidden">
                        </div>
                </div>
                 <div class="mb-6">
                    <h3 class="text-xl font-semibold text-emerald-600 mb-3">Modos de Carga para el Usuario</h3>
                     <div class="space-y-3 text-neutral-700">
                        <p><strong>Carga Profunda (Completa):</strong> Conectar hasta que el indicador cambie a verde (aprox. 7-9 horas). Recomendada tras uso intenso o descargas significativas para mantener la salud de la batería.</p>
                        <p><strong>Carga Parcial (Recarga):</strong> Cargar por periodos más cortos tras uso moderado. Ayuda a evitar descargas profundas frecuentes, pero se deben permitir ciclos completos periódicamente.</p>
                     </div>
                </div>
            </section>

            <section id="calculos" class="tab-content bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-emerald-700 mb-4">3. Cálculos y Herramientas Interactivas</h2>
                <p class="mb-6 text-neutral-700">Esta sección presenta cálculos importantes relacionados con estimaciones del tiempo y costo de carga, además de herramientas interactivas para comprender mejor el uso y mantenimiento de tu batería.</p>
                
                <div class="bg-stone-50 p-4 rounded-lg shadow mb-6">
                    <h3 class="text-xl font-semibold text-emerald-600 mb-3">Calculador de Tiempo y Costo de Carga Estimado</h3>
                    <p class="text-sm text-neutral-600 mb-3">Selecciona el estado de carga inicial (SoC) de la batería para estimar el tiempo, costo y energía consumida para cargar hasta el 100%. Considera 20Ah de capacidad nominal y 3A de corriente de carga.</p>
                    <div class="flex flex-col sm:flex-row items-center gap-4 mb-4">
                        <label for="socInicial" class="font-medium text-neutral-700">SoC Inicial (%):</label>
                        <input type="number" id="socInicial" min="0" max="99" value="20" class="p-2 border border-stone-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500 w-24" oninput="calcularTiempoYCostoCarga(); resetAndStartAmperageSimulation(this.value);">
                    </div>
                    <p id="tiempoCargaResultado" class="text-neutral-700 font-semibold"></p>
                    <div class="chart-container mt-4 h-[200px] sm:h-[250px]">
                        <canvas id="chartTiempoCarga"></canvas>
                    </div>
                </div>
                
                <div class="bg-emerald-50 p-4 rounded-lg shadow mb-6">
                    <h3 class="text-xl font-semibold text-emerald-700 mb-4">Herramientas Interactivas Adicionales</h3>

                    <div class="bg-white p-4 rounded-lg shadow mb-4">
                        <h4 class="text-lg font-semibold text-emerald-600 mb-3">Visualizador de Etapas de Carga 📈</h4>
                        <p class="text-sm text-neutral-600 mb-3">Observa cómo la batería se llena y cambia de color automáticamente a través de las fases de carga. La simulación inicia y se repite automáticamente.</p>
                        <div id="battery-visualizer">
                            <div id="battery-fill"></div>
                        </div>
                        <p id="stage-title-battery" class="text-xl font-bold text-emerald-800 mt-4 text-center">Carga Iniciada</p>
                        <p id="stage-description-battery" class="text-neutral-600 mt-2 text-center">La simulación de las etapas de carga se iniciará automáticamente.</p>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow mb-4">
                        <h4 class="text-lg font-semibold text-emerald-600 mb-3">Amperaje vs. SoC de Carga de Batería ⚡</h4>
                        <p class="text-sm text-neutral-600 mb-3">Este gráfico se actualiza automáticamente según el "SoC Inicial (%)" del calculador de tiempo de carga. Muestra cómo el amperaje de carga disminuye a medida que la batería se acerca al 100% de su estado de carga (SoC).</p>
                        <div class="chart-container">
                            <canvas id="amperageSoCChart"></canvas>
                        </div>
                        <p id="amperageSimulationStatus" class="text-center text-sm text-neutral-500 mt-4">Simulación en curso...</p>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h4 class="text-lg font-semibold text-emerald-600 mb-3">Impacto de la Temperatura en la Batería 🌡️</h4>
                        <p class="text-sm text-neutral-600 mb-3">La temperatura ambiente afecta el rendimiento y la vida útil de las baterías de plomo-ácido.</p>
                        <div class="flex flex-col sm:flex-row items-center gap-4 mb-3">
                            <label for="temperaturaAmbiente" class="block text-sm font-medium text-neutral-700 mb-1">Temperatura ambiente promedio:</label>
                            <select id="temperaturaAmbiente" class="p-2 border border-stone-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500 w-full md:w-auto" onchange="mostrarImpactoTemperatura()">
                                <option value="frio">Frío (0°C - 10°C)</option>
                                <option value="moderado" selected>Moderado (15°C - 25°C)</option>
                                <option value="caliente">Cálido (>30°C)</option>
                            </select>
                        </div>
                        <button onclick="mostrarImpactoTemperatura()" class="bg-emerald-600 text-white py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-emerald-700 transition-colors w-full mb-3">Ver Impacto</button>
                        <p id="impactoTemperaturaResultado" class="text-neutral-700 font-semibold"></p>
                    </div>

                </div>
                <div class="bg-stone-50 p-4 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-emerald-600 mb-3">Consideraciones de Seguridad y Mantenimiento</h3>
                    <ul class="list-disc list-inside text-neutral-700 space-y-2">
                        <li><strong>Ventilación Adecuada:</strong> Esencial durante la carga para disipar gas hidrógeno (inflamable). No cargar en espacios cerrados sin ventilación.</li>
                        <li><strong>Conexión/Desconexión Segura:</strong> Apagar el cargador de la red eléctrica antes de conectar o desconectar las baterías.</li>
                        <li><strong>Límite de Carga:</strong> No exceder 24 horas continuas de carga. Si el indicador no cambia a verde en un tiempo razonable (ej. 10-12h), investigar.</li>
                        <li><strong>No Desarmar:</strong> El cargador contiene componentes de alta tensión. No intentar reparaciones internas.</li>
                        <li><strong>Protección Ambiental:</strong> Usar en interiores, proteger de la lluvia y la humedad.</li>
                    </ul>
                </div>
            </section>

            <section id="conclusion" class="tab-content bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-emerald-700 mb-4">4. Conclusión y Recomendaciones</h2>
                <p class="mb-4 text-neutral-700">El diseño del centro de carga, utilizando el cargador modelo 120-60V17-24Ah, es una solución robusta y adecuada para el banco de baterías de 60V 20Ah de la motocicleta eléctrica. Las especificaciones del cargador se alinean perfectamente con los requerimientos de las baterías de plomo-ácido, asegurando una carga eficiente y segura a través de sus etapas automáticas de Bulk, Absorción y Flotación.</p>
                <p class="mb-4 text-neutral-700">Se recomienda al usuario seguir las pautas de carga (profunda y parcial) y las consideraciones de seguridad, especialmente en lo referente a la ventilación durante la carga. Con una implementación cuidadosa y un uso adecuado, este centro de carga proporcionará un rendimiento fiable y duradero para la motocicleta eléctrica.</p>
            </section>
        </main>
    </div>

    <script>
        // --- CONSTANTES GLOBALES ---
        const CAPACIDAD_NOMINAL_AH = 20;
        const CORRIENTE_CARGA_A = 3;
        const ENERGIA_ALMACENADA_KWH = 1.2; // kWh del banco de baterías
        const EFICIENCIA_CARGA_BAT = 0.85; // 85% de eficiencia para plomo-ácido
        const FACTOR_AJUSTE_ABSORCION = 1.25; // Factor para incluir tiempo de absorción
        const PRECIO_KWH_ECUADOR = 0.092; // 9.2 centavos de dólar por kilovatio-hora
        const VOLTAJE_NOMINAL_TOTAL = 60; // Voltaje nominal del banco de baterías

        // --- Funciones Auxiliares ---
        function formatHoursToHHMM(totalHours) {
            let hours = Math.floor(totalHours);
            let minutes = Math.round((totalHours - hours) * 60);

            // Asegurarse de que los minutos no lleguen a 60, sino que sumen una hora
            if (minutes === 60) {
                hours++;
                minutes = 0;
            }
            return `${hours}h ${minutes}m`;
        }

        // --- Lógica de Pestañas ---
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }
        
        // Abrir la primera pestaña por defecto y ejecutar funciones iniciales
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('.tab-button').click();
            calcularTiempoYCostoCarga(); // Ahora calcula tiempo Y costo Y kWh
            startBatteryStageSimulationLoop(); // Iniciar la simulación de la batería automáticamente
            mostrarImpactoTemperatura(); // Para el simulador de temperatura
            // La función resetAndStartAmperageSimulation ahora se llama desde oninput de socInicial
            // Así que no necesitamos llamarla aquí con un valor por defecto si el input ya tiene uno.
            const initialSoC = document.getElementById('socInicial').value; // Obtener el valor inicial
            resetAndStartAmperageSimulation(initialSoC); // Iniciar con el valor inicial del calculador de tiempo
        });

        // Lógica para Expandir/Colapsar Detalles
        function toggleDetails(elementId) {
            const content = document.getElementById(elementId);
            const arrow = event.currentTarget.querySelector('.details-arrow');
            content.classList.toggle('open');
            if (content.classList.contains('open')) {
                arrow.innerHTML = '&#9652;'; // Flecha arriba
                arrow.classList.add('rotate-180');

            } else {
                arrow.innerHTML = '&#9662;'; // Flecha abajo
                arrow.classList.remove('rotate-180');
            }
        }

        // Lógica para detalles de etapas de carga (en Cargador)
        const stageDetailsText = {
            bulk: "Durante la etapa Bulk, el cargador suministra su corriente máxima constante (3A) al banco de baterías. El voltaje del banco aumenta progresivamente. Esta fase es responsable de reponer la mayor parte de la energía de la batería y continúa hasta que el voltaje del banco alcanza los 73.5V.",
            absorption: "Una vez que el voltaje del banco alcanza los 73.5V, el cargador entra en la etapa de Absorción. Mantiene este voltaje constante, mientras que la corriente de carga comienza a disminuir gradualmente a medida que la resistencia interna de la batería aumenta. Esta etapa asegura que la batería alcance una carga completa del 100% sin sobrecargarla.",
            float: "Cuando la corriente de carga en la etapa de absorción cae a un nivel muy bajo, indica que la batería está completamente cargada. El cargador entonces cambia a la etapa de Flotación. En esta fase, el voltaje se reduce ligeramente (o se mantiene el voltaje de absorción con una corriente mínima) para mantener la batería en su estado de carga máxima, compensando la autodescarga natural y previniendo el daño por sobrecarga a largo plazo."
        };
        let lastSelectedStage = null;

        function showStageDetails(stageKey) {
            const detailsDisplay = document.getElementById('stage-details-display');
            const stageElement = document.getElementById('stage-' + stageKey);

            if (lastSelectedStage) {
                lastSelectedStage.classList.remove('ring-2', 'ring-emerald-500');
            }

            if (detailsDisplay.textContent === stageDetailsText[stageKey] && detailsDisplay.classList.contains('block')) {
                detailsDisplay.classList.add('hidden');
                detailsDisplay.classList.remove('block');
                lastSelectedStage = null;
            } else {
                detailsDisplay.textContent = stageDetailsText[stageKey];
                detailsDisplay.classList.remove('hidden');
                detailsDisplay.classList.add('block');
                stageElement.classList.add('ring-2', 'ring-emerald-500');
                lastSelectedStage = stageElement;
            }
        }

        // --- Lógica para Calculador de Tiempo y Costo de Carga (Unificado) ---
        let chartTiempoCarga;
        function calcularTiempoYCostoCarga() {
            const socInicial = parseFloat(document.getElementById('socInicial').value);
            const resultadoP = document.getElementById('tiempoCargaResultado');
            
            if (isNaN(socInicial) || socInicial < 0 || socInicial >= 100) {
                resultadoP.textContent = "Por favor, ingrese un SoC inicial válido (0-99%).";
                if(chartTiempoCarga) chartTiempoCarga.destroy();
                return;
            }

            const ahACargar = CAPACIDAD_NOMINAL_AH * (1 - socInicial / 100);
            const ahRequeridosCargador = ahACargar / EFICIENCIA_CARGA_BAT;
            const tiempoBulkT = ahRequeridosCargador / CORRIENTE_CARGA_A;
            const tiempoTotalEstimadoH = tiempoBulkT * FACTOR_AJUSTE_ABSORCION;

            // Calcular los kWh consumidos por el cargador
            // kWh consumidos = Ah_requeridos_cargador * Voltaje_nominal_banco / 1000
            const energiaConsumidaKWh = ahRequeridosCargador * VOLTAJE_NOMINAL_TOTAL / 1000;

            // Calcular el costo de la carga
            const costoTotal = energiaConsumidaKWh * PRECIO_KWH_ECUADOR;

            resultadoP.innerHTML = `Para un SoC inicial de ${socInicial}%: <br>
                                    Ah a reponer: ${ahACargar.toFixed(2)} Ah <br>
                                    Tiempo estimado de carga completa: <strong class="text-emerald-700">${formatHoursToHHMM(tiempoTotalEstimadoH)}</strong> <br>
                                    Energía consumida: <strong class="text-emerald-700">${energiaConsumidaKWh.toFixed(3)} kWh</strong> <br>
                                    Costo estimado de la carga: <strong class="text-emerald-700">$${costoTotal.toFixed(2)} USD</strong>.`;
            
            actualizarGraficoCarga(socInicial, tiempoTotalEstimadoH);
        }

        function actualizarGraficoCarga(socInicial, tiempoTotalEstimadoH) {
            const ctx = document.getElementById('chartTiempoCarga').getContext('2d');
            
            if (chartTiempoCarga) {
                chartTiempoCarga.destroy();
            }

            chartTiempoCarga = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Progreso de Carga Estimado'],
                    datasets: [
                        {
                            label: 'Cargado (%)',
                            data: [socInicial],
                            backgroundColor: 'rgba(16, 185, 129, 0.6)', // emerald-500
                            borderColor: 'rgba(5, 150, 105, 1)', // emerald-600
                            borderWidth: 1
                        },
                        {
                            label: 'Pendiente (%)',
                            data: [100 - socInicial],
                            backgroundColor: 'rgba(209, 213, 219, 0.6)', // gray-300
                            borderColor: 'rgba(156, 163, 175, 1)', // gray-400
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + "%"
                                }
                            }
                        },
                        y: {
                            stacked: true,
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Tiempo Total Estimado: ${formatHoursToHHMM(tiempoTotalEstimadoH)}`
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.x !== null) {
                                        label += context.parsed.x.toFixed(1) + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Lógica para Visualizador Interactivo de Etapas de Carga - NUEVO DISEÑO GRÁFICO DE BATERÍA ---
        let currentBatteryStageIndex = 0;
        let batteryStageInterval; // Variable para almacenar el ID del intervalo
        const batteryStagesData = [
            {
                title: "Carga Iniciada",
                description: "La simulación de las etapas de carga se iniciará automáticamente.",
                fillHeight: '0%', 
                bgColor: '#D1FAE5' // Light background
            },
            {
                title: "Etapa 1: Carga Bulk (Corriente Constante)",
                description: "El cargador entrega su corriente máxima (3A). El voltaje de la batería aumenta progresivamente. La batería se llena rápidamente.",
                fillHeight: '40%', // Ejemplo de nivel de llenado
                bgColor: '#EF4444' // Rojo
            },
            {
                title: "Etapa 2: Carga de Absorción (Voltaje Constante)",
                description: "El voltaje se mantiene constante (73.5V), mientras la corriente disminuye. La batería se acerca al 100%.",
                fillHeight: '75%', // Ejemplo de nivel de llenado
                bgColor: '#F59E0B' // Naranja
            },
            {
                title: "Etapa 3: Carga de Flotación (Mantenimiento)",
                description: "El voltaje se reduce o mantiene bajo, y la corriente es mínima. La batería está completamente cargada y se mantiene.",
                fillHeight: '100%', // Lleno
                bgColor: '#10B981' // Verde
            }
        ];

        function updateBatteryVisualizer(stageData) {
            const batteryFill = document.getElementById('battery-fill');
            const stageTitle = document.getElementById('stage-title-battery');
            const stageDescription = document.getElementById('stage-description-battery');

            batteryFill.style.height = stageData.fillHeight;
            batteryFill.style.backgroundColor = stageData.bgColor;
            stageTitle.textContent = stageData.title;
            stageDescription.textContent = stageData.description;
        }

        function nextChargingStageBattery() {
            currentBatteryStageIndex = (currentBatteryStageIndex + 1) % batteryStagesData.length;
            updateBatteryVisualizer(batteryStagesData[currentBatteryStageIndex]);
        }

        // Esta función ahora solo es llamada al inicio para resetear la simulación
        function startBatteryStageSimulationLoop() {
            stopBatteryStageSimulationLoop(); 
            currentBatteryStageIndex = 0; // Reinicia siempre a la primera etapa
            updateBatteryVisualizer(batteryStagesData[0]); // Muestra la primera etapa inmediatamente
            batteryStageInterval = setInterval(nextChargingStageBattery, 7000); // Actualizar cada 7 segundos
        }

        function stopBatteryStageSimulationLoop() {
            if (batteryStageInterval) {
                clearInterval(batteryStageInterval);
                batteryStageInterval = null;
            }
        }

        // --- Lógica para Gráfico Dinámico: Amperaje vs. SoC de Carga ---
        // Umbral de SoC donde la corriente comienza a disminuir (transición Bulk a Absorción)
        const SOC_TRANSITION_TO_ABSORPTION = 85; // %

        let amperageSoCChart;
        let amperageSimulationInterval;
        let currentSoCAmperage;
        let targetSoCAmperage = 100;
        let amperageSimulationPoints = []; // Stores {x: SoC, y: Amperage} points
        let amperageSimulationStep = 0.5; // Incremento de SoC por paso para la simulación

        function initializeAmperageChart() {
            const ctx = document.getElementById('amperageSoCChart').getContext('2d');
            if (amperageSoCChart) {
                amperageSoCChart.destroy();
            }

            amperageSoCChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Amperaje de Carga (A)',
                        data: [],
                        borderColor: '#059669', // emerald-600
                        backgroundColor: 'rgba(5, 150, 105, 0.2)',
                        fill: true,
                        tension: 0.3, // Curva suave
                        pointRadius: 3,
                        pointBackgroundColor: '#059669',
                        pointBorderColor: '#fff',
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0 // Desactivar animación por defecto de Chart.js para control manual
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Estado de Carga (SoC %)'
                            },
                            ticks: {
                                stepSize: 10
                            }
                        },
                        y: {
                            min: 0,
                            max: CORRIENTE_CARGA_A * 1.1, // Un poco más que la corriente máxima
                            title: {
                                display: true,
                                text: 'Amperaje (A)'
                            },
                            ticks: {
                                stepSize: 0.5
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `SoC: ${context.parsed.x.toFixed(1)}% | Amperaje: ${context.parsed.y.toFixed(2)} A`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function simulateAmperageChargingStep() {
            const statusText = document.getElementById('amperageSimulationStatus');

            if (currentSoCAmperage >= targetSoCAmperage) {
                clearInterval(amperageSimulationInterval);
                statusText.textContent = `Simulación completada al ${targetSoCAmperage}% SoC.`;
                return;
            }

            let currentAmperage;
            if (currentSoCAmperage < SOC_TRANSITION_TO_ABSORPTION) {
                // Etapa Bulk: Corriente constante
                currentAmperage = CORRIENTE_CARGA_A;
            } else {
                // Etapa de Absorción: Corriente disminuye exponencialmente
                // Simulación de caída exponencial: A = A_max * e^(-k * (SoC - SoC_transicion))
                const k = 0.1; // Factor de decaimiento, ajusta para una caída más rápida/lenta
                const socDifference = currentSoCAmperage - SOC_TRANSITION_TO_ABSORPTION;
                currentAmperage = CORRIENTE_CARGA_A * Math.exp(-k * socDifference);
                
                // Asegurar que la corriente no sea negativa y tenga un mínimo (flotación)
                currentAmperage = Math.max(currentAmperage, 0.1); // Mínimo de 0.1A para flotación
            }
            
            // Si nos acercamos mucho al 100%, la corriente debería caer a 0 o flotación mínima
            if (currentSoCAmperage >= 99.5) {
                currentAmperage = 0.05; // Muy baja corriente de flotación
            }
            if (currentSoCAmperage >= 99.9) {
                currentAmperage = 0; // Prácticamente cero al 100%
            }


            amperageSimulationPoints.push({ x: currentSoCAmperage, y: currentAmperage });
            amperageSoCChart.data.datasets[0].data = amperageSimulationPoints;
            amperageSoCChart.update(); // Actualiza el gráfico

            currentSoCAmperage += amperageSimulationStep; // Avanza el SoC
            if (currentSoCAmperage > targetSoCAmperage) {
                currentSoCAmperage = targetSoCAmperage; // Asegura que no se pase del 100%
            }
            statusText.textContent = `Simulación en curso... SoC actual: ${currentSoCAmperage.toFixed(1)}%`;
        }

        // Modificada para recibir el initialSoC como parámetro
        function resetAndStartAmperageSimulation(initialSoC) {
            clearInterval(amperageSimulationInterval); // Detener cualquier simulación anterior
            
            let newInitialSoC = parseFloat(initialSoC);

            if (isNaN(newInitialSoC) || newInitialSoC < 0 || newInitialSoC >= 100) {
                newInitialSoC = 20; // Valor por defecto si es inválido
                // Ya no necesitamos actualizar el input aquí porque viene del otro input.
                document.getElementById('amperageSimulationStatus').textContent = "SoC Inicial inválido del calculador principal. Usando 20%.";
            } else {
                 document.getElementById('amperageSimulationStatus').textContent = `Simulación iniciada desde ${newInitialSoC}% SoC.`;
            }

            currentSoCAmperage = newInitialSoC;
            amperageSimulationPoints = []; // Limpiar puntos anteriores
            initializeAmperageChart(); // Re-inicializar el gráfico

            // Añadir el punto inicial al gráfico
            let initialAmperage = (currentSoCAmperage < SOC_TRANSITION_TO_ABSORPTION) ? CORRIENTE_CARGA_A : (CORRIENTE_CARGA_A * Math.exp(-0.1 * (currentSoCAmperage - SOC_TRANSITION_TO_ABSORPTION)));
            initialAmperage = Math.max(initialAmperage, 0.05); // Asegurar un mínimo
            if (currentSoCAmperage >= 99.9) initialAmperage = 0;

            amperageSimulationPoints.push({ x: currentSoCAmperage, y: initialAmperage });
            amperageSoCChart.data.datasets[0].data = amperageSimulationPoints;
            amperageSoCChart.update();

            amperageSimulationInterval = setInterval(simulateAmperageChargingStep, 100); // Actualizar cada 100ms
        }

        // 5. Impacto de la Temperatura en la Batería
        function mostrarImpactoTemperatura() {
            const temperatura = document.getElementById('temperaturaAmbiente').value;
            const resultadoP = document.getElementById('impactoTemperaturaResultado');
            let mensaje = "";

            switch (temperatura) {
                case 'frio':
                    mensaje = `En ambientes fríos (0°C - 10°C):
                    - La capacidad útil de la batería disminuye temporalmente.
                    - La carga es más lenta y puede ser menos eficiente.
                    - Si la batería está congelada, ¡no la cargues! Podría dañarse irreversiblemente.
                    - Recomendación: Almacena la batería en un lugar cálido si no la usas. Carga en un ambiente templado si es posible.`;
                    break;
                case 'moderado':
                    mensaje = `En ambientes moderados (15°C - 25°C):
                    - Esta es la temperatura ideal de operación y carga para la mayoría de las baterías de plomo-ácido.
                    - La eficiencia es óptima y la vida útil se maximiza bajo estas condiciones.
                    - Asegura una buena ventilación para evitar cualquier acumulación de calor residual durante la carga.`;
                    break;
                case 'caliente':
                    mensaje = `En ambientes cálidos (>30°C):
                    - La vida útil de la batería se reduce significativamente por cada 10°C por encima de 25°C.
                    - Riesgo de sobrecarga o 'thermal runaway' es mayor.
                    - La autodescarga se acelera.
                    - Recomendación: Evita cargar la batería en lugares muy calientes. Asegura ventilación extrema. Si la batería está muy caliente, déjala enfriar antes de cargarla.`;
                    break;
                default:
                    mensaje = "Selecciona una condición de temperatura para ver su impacto.";
            }
            resultadoP.innerHTML = mensaje.replace(/\n/g, '<br>'); // Formatear para HTML
        }
    </script>
</body>
</html>
